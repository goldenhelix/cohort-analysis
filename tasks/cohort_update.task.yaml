# yaml-language-server: $schema=https://www.schemastore.org/any.json
name: Cohort Annotation Track Updater
description: |-
  # Update Cohort Variant Frequencies

  Updates a cohort variant frequencies track by adding new samples.

  ## Process Overview
  This task merges variant data from new VCF files into an existing cohort variant
  frequencies track. It:
  1. Reads variants from the input VCF files
  2. Filters variants based on INFO and FORMAT fields filters
  3. Merges the filtered variants with any existing variant counts
  4. Updates the cohort parameter file with the new settings

  ## Important Note
  This task should not be run directly. Instead:
  1. Use the "Build Cohort Annotation Track" workflow
  2. Select your existing cohort parameter file
  3. Select the folder containing your new VCF files

  The workflow will automatically run this task with the correct parameters.

agent_requirements:
  cpu_cores: 8
  memory_gb: 16

alternative_agent_requirements:
  Small (256):
    cpu_cores: 8
    memory_gb: 16
    description: Up to ~256 samples (benchmarked at 8GB for 256 samples)
  Medium (512):
    cpu_cores: 16
    memory_gb: 32
    description: Up to ~512 samples (benchmarked at 16GB for 512 samples)
  Large (1024):
    cpu_cores: 32
    memory_gb: 64
    description: Up to ~1024 samples (benchmarked at 40GB for 1024 samples)
  XLarge (2048):
    cpu_cores: 64
    memory_gb: 128
    description: Up to ~2048 samples (benchmarked at 70GB for 2048 samples)
  XXLarge (4096):
    cpu_cores: 64
    memory_gb: 256
    description: Up to ~4096 samples (benchmarked at 140GB for 4096 samples)

parameters:
  - name: manifest_parameter_file
    type: file
    label: Manifest File
    help: Text file containing paths to manifests and their processed outputs
    pattern_match: ["*.csv"]

  - name: parameter_file
    type: file
    label: Parameter File
    help: Parameter file for the cohort

  - name: existing_counts
    type: file
    label: Existing Counts File
    help: Optional TSF file containing existing variant counts to update
    pattern_match: ["*.tsf"]
    optional: true

  - name: out_file
    type: file
    label: Output File Base Name
    help: The output file to create
    group: "Advanced Options"
    create: true
    optional: true

steps:
  - name: create_cohort
    description: Create the initial cohort
    type: cmd
    command: bash
    args:
      - |- # shell
        #!/usr/bin/env bash
        set -ex
        python3 "${TASK_DIR}/../scripts/cohort_merge.py" \
          --manifest-parameter-file "${manifest_parameter_file}" \
          --config "${parameter_file}" \
          --existing-counts "${existing_counts}" \
          --out-file "${out_file}"
